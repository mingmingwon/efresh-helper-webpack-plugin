"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,n){for(var r=0;r<n.length;r++){var t=n[r];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}function _createClass(e,n,r){return n&&_defineProperties(e.prototype,n),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}var chalk=require("chalk"),dayjs=require("dayjs"),_require=require("fs"),readFileSync=_require.readFileSync,writeFileSync=_require.writeFileSync,_require2=require("webpack"),DefinePlugin=_require2.DefinePlugin,errLog=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"error";console.log("\n".concat(chalk.white.bgRed(" ERROR ")).concat(chalk.red(" [refresh-helper-webpack-plugin] "+e))),process.exit(1)};module.exports=function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=n.pages,t=void 0===r?[]:r,i=n.message,a=void 0===i?"发现新版本啦":i,o=n.btnText,s=void 0===o?"更新":o,c=n.throttle,l=void 0===c?6e4:c,f=n.iframe,u=void 0!==f&&f;_classCallCheck(this,e);var d=require("".concat(process.cwd(),"/vue.config.js")).pages||{index:"public/index.html"};t=(t=Array.isArray(t)?t:[t]).length?t:Object.keys(d).map((function(e){var n=d[e];return"string"==typeof n?"".concat(e,".html"):n.filename})),this.config={pages:t,message:a,btnText:s,throttle:l,iframe:u}}return _createClass(e,[{key:"apply",value:function(e){var n=this,r=function(){var r=dayjs();n.version=r.format("YYYY.MM.DD.HHmmss"),n.datetime=r.format("YYYY-MM-DD HH:mm:ss"),new DefinePlugin({"process.env.VUE_APP_VERSION":JSON.stringify(n.version)}).apply(e)},t=function(e,r){n.hash=e.hash,n.config.pages.forEach((function(r){var t=e.assets[r];t||errLog("Can't find the page ".concat(chalk.yellow(r),", please check ").concat(chalk.yellow("pages")," configuration")),n.appendScript(t.existsAt)})),n.recordRelease(e.outputOptions.path),r()};e.hooks?(e.hooks.afterPlugins.tap("after-plugins",r),e.hooks.afterEmit.tapAsync("after-emit",t)):(e.plugin("after-plugins",r),e.plugin("after-emit",t))}},{key:"appendScript",value:function(e){try{var n=readFileSync(e,"utf-8");writeFileSync(e,n.replace(/(<\/body>)/,"".concat(this.generateScript(),"$1")))}catch(e){errLog(e)}}},{key:"generateScript",value:function(){return"\n      <script type=\"text/javascript\" id=\"__refresh_script__\">\n        (function () {\n          var id = '__refresh_helper__';\n          function getRefresh () {\n            return document.querySelector('#' + id);\n          }\n          function refreshHandler () {\n            if (/(iPhone|iPad|iOS|Android)/i.test(navigator.userAgent)) {\n              location.reload();\n            } else if (window !== window.parent && !".concat(this.config.iframe,") {\n              location.reload();\n            } else {\n              var refresh = getRefresh();\n              if (!refresh) {\n                refresh = document.createElement('div');\n                refresh.id = id;\n                refresh.style = 'position: fixed; z-index: 99999; background-color: #fff; right: 20px; bottom: 20px; text-align: center; box-shadow: rgba(0, 0, 0, .1) 0 2px 6px 1px; border-radius: 3px; padding: 10px 15px; font-size: 12px;';\n                var message = document.createElement('p');\n                message.innerHTML = '").concat(this.config.message,"';\n                refresh.appendChild(message);\n                var button = document.createElement('button');\n                button.style = 'margin-top: 5px; padding: 0 15px; height: 24px; line-height: 1; color: #4453db; background-color: #dde8ff; border: 1px solid #dde8ff; font-size: 12px; border-radius: 3px; cursor: pointer; outline: none; -webkit-appearance: none;';\n                button.innerHTML = '").concat(this.config.btnText,"';\n                button.addEventListener('click', function () {\n                  location.reload();\n                });\n                refresh.appendChild(button);\n                document.body.appendChild(refresh);\n              }\n              refresh.style.display = 'block';\n            }\n          }\n          function createXHR (cb) {\n            var xhr = new XMLHttpRequest();\n            xhr.onreadystatechange = function () {\n              if (xhr.readyState === 4 && (xhr.status === 200 || xhr.status === 304)) {\n                document.visibilityState === 'visible' && cb.call(xhr, JSON.parse(xhr.responseText).version);\n              }\n            };\n            return function () {\n              xhr.open('GET', '/release.json?t=' + new Date().getTime());\n              xhr.send();\n              return xhr;\n            };\n          }\n          var xhr = createXHR(function (version) {\n            if ('").concat(this.version,"' !== version) {\n              refreshHandler();\n            }\n          });\n          var req = null;\n          var ajax = (function throttle(fn, delay) {\n            var timer;\n            return function () {\n              if (timer) return;\n              timer = setTimeout(function () {\n                timer = null;\n              }, delay);\n              fn.apply(this, arguments);\n            };\n          })(xhr, ").concat(this.config.throttle,");\n          document.addEventListener('visibilitychange', function () {\n            if (document.visibilityState === 'visible') {\n              if (!getRefresh()) {\n                req = ajax();\n              }\n            } else {\n              req && req.readyState !== 4 && req.abort();\n            }\n          });\n        })();\n      <\/script>\n    ").split(/[\r\n]/).map((function(e){return e.trim()})).join("")}},{key:"recordRelease",value:function(e){try{writeFileSync("".concat(e,"/release.json"),JSON.stringify({version:this.version,datetime:this.datetime,hash:this.hash},null,2))}catch(e){errLog(e)}}},{key:"error",value:function(e){errLog(e)}}]),e}();
