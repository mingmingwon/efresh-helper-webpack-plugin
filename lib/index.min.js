"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,n,t){return n&&_defineProperties(e.prototype,n),t&&_defineProperties(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}var chalk=require("chalk"),dayjs=require("dayjs"),_require=require("fs"),readFileSync=_require.readFileSync,writeFileSync=_require.writeFileSync,errLog=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"error";console.log("\n".concat(chalk.white.bgRed(" ERROR ")).concat(chalk.red(" [refresh-helper-webpack-plugin] "+e))),process.exit(1)};module.exports=function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=n.pages,r=void 0===t?[]:t,i=n.message,a=void 0===i?"发现新版本啦":i,o=n.btnText,c=void 0===o?"更新":o,s=n.throttle,l=void 0===s?6e4:s;_classCallCheck(this,e);var u=require("".concat(process.cwd(),"/vue.config.js")).pages;r=(r=Array.isArray(r)?r:[r]).length?r:Object.keys(u).map((function(e){var n=u[e];return"string"==typeof n?"".concat(e,".html"):n.filename})),this.config={pages:r,message:a,btnText:c,throttle:l}}return _createClass(e,[{key:"apply",value:function(e){var n=this,t=function(e,t){n.version=e.hash,n.datetime=dayjs().format("YYYY-MM-DD HH:mm:ss"),n.config.pages.forEach((function(t){var r=e.assets[t];r||errLog("Can't find the page ".concat(chalk.yellow(t),", please check ").concat(chalk.yellow("pages")," configuration")),n.appendScript(r.existsAt)})),n.recordInfos(e.outputOptions.path),t()};e.hooks?e.hooks.afterEmit.tapAsync("afterEmit",t):e.plugin("after-emit",t)}},{key:"appendScript",value:function(e){try{var n=readFileSync(e,"utf-8");writeFileSync(e,n.replace(/(<\/body>)/,"".concat(this.generateScript(),"$1")))}catch(e){errLog(e)}}},{key:"generateScript",value:function(){return"\n      <script type=\"text/javascript\" id=\"__refresh_script__\">\n        (function () {\n          function refreshHandler () {\n            if (/(iPhone|iPad|iOS|Android)/i.test(navigator.userAgent)) {\n              location.reload();\n            } else {\n              var refresh = document.querySelector('#__refresh__');\n              if (!refresh) {\n                refresh = document.createElement('div');\n                refresh.id = '__refresh__';\n                refresh.style = 'position: fixed; z-index: 99999; background-color: #fff; right: 20px; bottom: 20px; text-align: center; box-shadow: rgba(0, 0, 0, .1) 0 2px 6px 1px; border-radius: 3px; padding: 10px 15px; font-size: 12px;';\n                var message = document.createElement('p');\n                message.innerHTML = '".concat(this.config.message,"';\n                refresh.appendChild(message);\n                var button = document.createElement('button');\n                button.style = 'margin-top: 5px; padding: 0 15px; height: 24px; line-height: 1; color: #4453db; background-color: #dde8ff; border: 1px solid #dde8ff; font-size: 12px; border-radius: 3px; cursor: pointer; outline: none; -webkit-appearance: none;';\n                button.innerHTML = '").concat(this.config.btnText,"';\n                button.addEventListener('click', function () {\n                  location.reload();\n                });\n                refresh.appendChild(button);\n                document.body.appendChild(refresh);\n              }\n              refresh.style.display = 'block';\n            }\n          }\n          function createXHR (cb) {\n            var xhr = new XMLHttpRequest();\n            xhr.onreadystatechange = function () {\n              if (xhr.readyState === 4 && (xhr.status === 200 || xhr.status === 304)) {\n                document.visibilityState === 'visible' && cb.call(xhr, JSON.parse(xhr.responseText).version);\n              }\n            };\n            return function () {\n              xhr.open('GET', '/release.json?t=' + new Date().getTime());\n              xhr.send();\n              return xhr;\n            };\n          }\n          var xhr = createXHR(function (version) {\n            if ('").concat(this.version,"' !== version) {\n              refreshHandler();\n            }\n          });\n          var req = null;\n          var ajax = (function throttle(fn, delay) {\n            var timer;\n            return function () {\n              if (timer) return;\n              timer = setTimeout(function () {\n                timer = null;\n              }, delay);\n              fn.apply(this, arguments);\n            };\n          })(xhr, ").concat(this.config.throttle,");\n          document.addEventListener('visibilitychange', function () {\n            if (document.visibilityState === 'visible') {\n              req = ajax();\n            } else {\n              req && req.readyState !== 4 && req.abort();\n            }\n          });\n        })();\n      <\/script>\n    ").split(/[\r\n]/).map((function(e){return e.trim()})).join("")}},{key:"recordInfos",value:function(e){try{writeFileSync("".concat(e,"/release.json"),JSON.stringify({version:this.version,datetime:this.datetime},null,2))}catch(e){errLog(e)}}},{key:"error",value:function(e){errLog(e)}}]),e}();
