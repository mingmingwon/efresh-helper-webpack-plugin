"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);Object.defineProperty(Constructor,"prototype",{writable:false});return Constructor;}var chalk=require('chalk');var dayjs=require('dayjs');var _require=require('fs'),readFileSync=_require.readFileSync,writeFileSync=_require.writeFileSync;var errLog=function errLog(){var msg=arguments.length>0&&arguments[0]!==undefined?arguments[0]:'error';console.log("\n".concat(chalk.white.bgRed(' ERROR ')).concat(chalk.red(' [refresh-helper-webpack-plugin] '+msg)));process.exit(1);};module.exports=/*#__PURE__*/function(){function RefreshHelperWebpackPlugin(){var _ref=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref$pages=_ref.pages,pages=_ref$pages===void 0?[]:_ref$pages,_ref$message=_ref.message,message=_ref$message===void 0?'发现新版本啦':_ref$message,_ref$btnText=_ref.btnText,btnText=_ref$btnText===void 0?'更新':_ref$btnText,_ref$throttle=_ref.throttle,throttle=_ref$throttle===void 0?60000:_ref$throttle;_classCallCheck(this,RefreshHelperWebpackPlugin);var uPages=require("".concat(process.cwd(),"/vue.config.js")).pages;pages=Array.isArray(pages)?pages:[pages];pages=pages.length?pages:Object.keys(uPages).map(function(item){var page=uPages[item];return typeof page==='string'?"".concat(item,".html"):page.filename;});this.config={pages:pages,message:message,btnText:btnText,throttle:throttle};}_createClass(RefreshHelperWebpackPlugin,[{key:"apply",value:function apply(compiler){var _this=this;var afterEmit=function afterEmit(compilation,callback){_this.version=compilation.hash;_this.datetime=dayjs().format('YYYY-MM-DD HH:mm:ss');_this.config.pages.forEach(function(item){var page=compilation.assets[item];if(!page){errLog("Can't find the page ".concat(chalk.yellow(item),", please check ").concat(chalk.yellow('pages')," configuration"));}_this.appendScript(page.existsAt);});_this.recordInfos(compilation.outputOptions.path);callback();};if(compiler.hooks){compiler.hooks.afterEmit.tapAsync('afterEmit',afterEmit);}else{compiler.plugin('after-emit',afterEmit);}}},{key:"appendScript",value:function appendScript(pageFile){try{var content=readFileSync(pageFile,'utf-8');writeFileSync(pageFile,content.replace(/(<\/body>)/,"".concat(this.generateScript(),"$1")));}catch(err){errLog(err);}}},{key:"generateScript",value:function generateScript(){return"\n      <script type=\"text/javascript\" id=\"__refresh_script__\">\n        (function () {\n          function refreshHandler () {\n            if (/(iPhone|iPad|iOS|Android)/i.test(navigator.userAgent)) {\n              location.reload();\n            } else {\n              var refresh = document.querySelector('#__refresh__');\n              if (!refresh) {\n                refresh = document.createElement('div');\n                refresh.id = '__refresh__';\n                refresh.style = 'position: fixed; z-index: 99999; background-color: #fff; right: 20px; bottom: 20px; text-align: center; box-shadow: rgba(0, 0, 0, .1) 0 2px 6px 1px; border-radius: 3px; padding: 10px 15px; font-size: 12px;';\n                var message = document.createElement('p');\n                message.innerHTML = '".concat(this.config.message,"';\n                refresh.appendChild(message);\n                var button = document.createElement('button');\n                button.style = 'margin-top: 5px; padding: 0 15px; height: 24px; line-height: 1; color: #4453db; background-color: #dde8ff; border: 1px solid #dde8ff; font-size: 12px; border-radius: 3px; cursor: pointer; outline: none; -webkit-appearance: none;';\n                button.innerHTML = '").concat(this.config.btnText,"';\n                button.addEventListener('click', function () {\n                  location.reload();\n                });\n                refresh.appendChild(button);\n                document.body.appendChild(refresh);\n              }\n              refresh.style.display = 'block';\n            }\n          }\n          function createXHR (cb) {\n            var xhr = new XMLHttpRequest();\n            xhr.onreadystatechange = function () {\n              if (xhr.readyState === 4 && (xhr.status === 200 || xhr.status === 304)) {\n                document.visibilityState === 'visible' && cb.call(xhr, JSON.parse(xhr.responseText).version);\n              }\n            };\n            return function () {\n              xhr.open('GET', '/release.json?t=' + new Date().getTime());\n              xhr.send();\n              return xhr;\n            };\n          }\n          var xhr = createXHR(function (version) {\n            if ('").concat(this.version,"' !== version) {\n              refreshHandler();\n            }\n          });\n          var req = null;\n          var ajax = (function throttle(fn, delay) {\n            var timer;\n            return function () {\n              if (timer) return;\n              timer = setTimeout(function () {\n                timer = null;\n              }, delay);\n              fn.apply(this, arguments);\n            };\n          })(xhr, ").concat(this.config.throttle,");\n          document.addEventListener('visibilitychange', function () {\n            if (document.visibilityState === 'visible') {\n              req = ajax();\n            } else {\n              req && req.readyState !== 4 && req.abort();\n            }\n          });\n        })();\n      </script>\n    ").split(/[\r\n]/).map(function(line){return line.trim();}).join('');}},{key:"recordInfos",value:function recordInfos(rootPath){try{writeFileSync("".concat(rootPath,"/release.json"),JSON.stringify({version:this.version,datetime:this.datetime},null,2));}catch(err){errLog(err);}}},{key:"error",value:function error(err){errLog(err);}}]);return RefreshHelperWebpackPlugin;}();
